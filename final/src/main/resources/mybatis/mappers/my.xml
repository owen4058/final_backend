<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
      PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.my">
	<resultMap id="profile" type="profile">
        <result property="user_id" column="user_id" />
        <result property="nickname" column="nickname" />
        <result property="pro_path" column="pro_path" />
        <result property="following_count" column="following_count" />
        <result property="follower_count" column="follower_count" />
        <result property="board_count" column="board_count" />
        <result property="comment_count" column="comment_count" />
        <result property="likes_count" column="likes_count" />
    </resultMap>
    
   	<resultMap id="boardform" type="boardform">
        <result property="board_id" column="board_id" />
        <result property="section_id" column="section_id" />
        <result property="forum_id" column="forum_id" />
        <result property="board_like_state" column="board_like_state" />
        <result property="board_save_state" column="board_save_state" />
        <result property="nickname" column="nickname" />
        <result property="user_id" column="user_id" />
        <result property="pro_path" column="pro_path" />
        <result property="title" column="title" />
        <result property="content" column="content" />
        <result property="hits" column="hits" />
        <result property="like_count" column="like_count" />
        <result property="comment_count" column="comment_count" />
        <result property="create_date" column="create_date" />
         <collection  property="img" ofType="boardimg" javaType="List">
			<result property="img_id" column="img_id"/>
			<result property="board_id" column="board_id"/>
			<result property="img_name" column="img_name"/>
			<result property="img_path" column="img_path"/>
		</collection>
		<collection  property="tag" ofType="hashtag" javaType="List">
			<result property="hastag_id" column="hastag_id"/>
			<result property="board_id" column="board_id"/>
			<result property="hashtag_name" column="hashtag_name"/>
		</collection>
	</resultMap>
	
	<select id="myBoardList" resultMap = "boardform" parameterType= "int">
       	<![CDATA[
		SELECT 
			c.*,
			d.pro_path,
			d.nickname,
			e.*,
			f.*,
			CASE 
               WHEN g.user_id  IS NOT NULL THEN 1
               ELSE 0
            END AS board_like_state,
            CASE 
               WHEN h.user_id  IS NOT NULL THEN 1
               ELSE 0
            END AS board_save_state
		FROM 
			(
			SELECT 
				ROWNUM AS RNUM, 
				A.* 
			FROM 
				(
				SELECT 
					* 
				FROM 
					board  
					where forum_id =  #{forum_id}
					AND
					section_id =  #{section_id}					
					ORDER BY board_id DESC
				) A 
				WHERE ROWNUM <= #{page} * 5
			) c 
			LEFT OUTER JOIN	USERS d	ON	c.user_id = d.user_id
			LEFT OUTER JOIN img e ON c.board_id = e.board_id
        	LEFT OUTER JOIN	hashtag f ON c.board_id = f.board_id
        	LEFT OUTER JOIN	board_like g ON c.board_id = g.board_id and g.user_id = #{user_id}
            LEFT OUTER JOIN	BOARD_SAVE h ON c.board_id = h.board_id and h.user_id = #{user_id}
         WHERE c.user_id = #{user_id}
        ]]>
	</select>

  <select id="myCommentBoardList" resultMap="boardform" parameterType="int">
	  <![CDATA[  
	    SELECT
	      c.*,  
	      d.pro_path,
	      d.nickname,
	      e.*,
	      f.*,
	      CASE 
	        WHEN g.user_id IS NOT NULL THEN 1
	        ELSE 0
	      END AS board_like_state,
	      CASE
	        WHEN h.user_id IS NOT NULL THEN 1  
	        ELSE 0
	     END AS board_save_state
	    FROM 
	     (
	       SELECT
	         ROWNUM AS RNUM, A.*
	       FROM  
	       (  
	         SELECT *
	         FROM board
	         WHERE user_id = #{user_id}
	         ORDER BY board_id DESC
	       ) A
	       WHERE ROWNUM <= #{page} * 5
	     ) c   
	    LEFT OUTER JOIN USERS d ON c.user_id = d.user_id
	    LEFT OUTER JOIN img e ON c.board_id = e.board_id 
	    LEFT OUTER JOIN hashtag f ON c.board_id = f.board_id
	    LEFT OUTER JOIN board_like g  
	      ON c.board_id = g.board_id AND g.user_id = #{user_id}
	    LEFT OUTER JOIN BOARD_SAVE h    
	      ON c.board_id = h.board_id AND h.user_id = #{user_id}
	  ]]>

	</select>
	<select id="myLikedBoardList" resultMap="boardform" parameterType="int">
		<![CDATA[ 
			SELECT 
			    c.*, 
			    d.pro_path, 
			    d.nickname, 
			    e.*, 
			    f.*, 
			    CASE 
			        WHEN g.user_id IS NOT NULL THEN 1 
			        ELSE 0 
			    END AS board_like_state, 
			    CASE 
			        WHEN h.user_id IS NOT NULL THEN 1 
			        ELSE 0 
			    END AS board_save_state 
			FROM (
			    SELECT 
			        ROWNUM AS RNUM, 
			        A.* 
			    FROM (
			        SELECT 
			            board.* 
			        FROM 
			            board
			            JOIN board_like ON board.board_id = board_like.board_id
			        WHERE 
			            board_like.user_id = #{user_id}
			            AND board.forum_id = #{forum_id}
			            AND board.section_id = #{section_id}                    
			        ORDER BY 
			            board.board_id DESC
			    ) A 
			    WHERE ROWNUM <= #{page} * 5
			) c 
			LEFT OUTER JOIN USERS d ON c.user_id = d.user_id 
			LEFT OUTER JOIN img e ON c.board_id = e.board_id 
			LEFT OUTER JOIN hashtag f ON c.board_id = f.board_id 
			LEFT OUTER JOIN board_like g ON c.board_id = g.board_id AND g.user_id = #{user_id} 
			LEFT OUTER JOIN BOARD_SAVE h ON c.board_id = h.board_id AND h.user_id = #{user_id}
			WHERE c.RNUM > (#{page}-1) * 5;
		]]>
	</select>
	<select id="mySavedBoardList" resultMap="boardform" parameterType="int">
	<![CDATA[ 
		SELECT
		    c.*, 
		    d.pro_path, 
		    d.nickname, 
		    e.*, 
		    f.*, 
		    CASE WHEN g.user_id IS NOT NULL THEN 1 
		        ELSE 0 
		    END AS board_like_state,
		    CASE WHEN h.user_id IS NOT NULL THEN 1 
		        ELSE 0 
		    END AS board_save_state
		FROM
		    (
		    SELECT 
		        ROWNUM AS RNUM,
		        A.* 
		    FROM 
		        (
		        SELECT 
		            * 
		        FROM 
		            board
		        WHERE 
		            forum_id = #{forum_id}
		            AND section_id = #{section_id}
		        ORDER BY 
		            board_id DESC
		        ) A 
		    WHERE 
		        ROWNUM <= #{page} * 5
		    ) c 
		LEFT OUTER JOIN USERS d 
		    ON c.user_id = d.user_id
		LEFT OUTER JOIN img e 
		    ON c.board_id = e.board_id
		LEFT OUTER JOIN hashtag f 
		    ON c.board_id = f.board_id
		LEFT OUTER JOIN board_like g 
		    ON c.board_id = g.board_id AND g.user_id = #{user_id}
		LEFT OUTER JOIN board_save h 
		    ON c.board_id = h.board_id AND h.user_id = #{user_id}
		WHERE 
		    EXISTS (
		        SELECT 1 
		        FROM board_save bs 
		        WHERE bs.user_id = #{user_id} AND bs.board_id = c.board_id
		    );
	]]>
	</select>

</mapper>
